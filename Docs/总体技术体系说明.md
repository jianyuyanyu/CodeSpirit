## æ€»ä½“æŠ€æœ¯ä½“ç³»è¯´æ˜

## 1. æ¶æ„æ¦‚è§ˆ

CodeSpiritï¼ˆç çµï¼‰æ˜¯ä¸€æ¬¾åŸºäº.NET 9æ„å»ºçš„å…¨æ ˆä½ä»£ç å¼€å‘æ¡†æ¶ï¼Œé€šè¿‡æ™ºèƒ½ä»£ç ç”Ÿæˆå¼•æ“ä¸AIæ·±åº¦ååŒï¼Œå®ç°åç«¯é©±åŠ¨å¼å…¨æ ˆå¼€å‘èŒƒå¼ã€‚æ¡†æ¶é‡‡ç”¨Clean Architectureåˆ†å±‚è®¾è®¡ï¼Œæä¾›ä»ç•Œé¢ç”Ÿæˆã€ä¸šåŠ¡é€»è¾‘ç¼–æ’åˆ°ç³»ç»Ÿè¿ç»´çš„å…¨ç”Ÿå‘½å‘¨æœŸæ”¯æŒã€‚

### 1.1 æ¶æ„å›¾

```mermaid
flowchart TD
    classDef uiLayer fill:#f9d1d1,stroke:#333,stroke-width:1px
    classDef backendLayer fill:#d1f9d1,stroke:#333,stroke-width:1px
    classDef cloudLayer fill:#d1d1f9,stroke:#333,stroke-width:1px
    
    subgraph UI["æ™ºèƒ½ç•Œé¢ç”Ÿæˆå¼•æ“"]
        direction LR
        A1["ğŸ§­ åŠ¨æ€å¯¼èˆªç³»ç»Ÿ"] --> A2["ğŸ“ æ™ºèƒ½è¡¨å•"]
        A2 --> A3["ğŸ“Š æ™ºèƒ½è¡¨æ ¼"]
        A3 --> A4["ğŸ“¦ æ‰¹é‡å¤„ç†"]
    end
    
    subgraph Backend["ä¼ä¸šçº§åç«¯æ¶æ„"]
        direction LR
        B1["ğŸ” æƒé™ç³»ç»Ÿ"] --> B2["ğŸ’¾ ORMæ‰©å±•"]
        B2 --> B3["ğŸ¢ å¤šç§Ÿæˆ·"]
        B3 --> B4["ğŸ“‹ å®¡è®¡æœåŠ¡"]
    end
    
    subgraph Cloud["äº‘åŸç”Ÿåº•åº§"]
        direction LR
        C1["ğŸš€ .NET Aspire"] --> C2["âš™ï¸ é…ç½®ä¸­å¿ƒï¼ˆå†…ç½®ï¼‰"]
        C2 --> C3["â˜¸ï¸ K8sæ”¯æŒ"]
        C3 --> C4["ğŸ“¦ åˆ†å¸ƒå¼ç¼“å­˜"]
    end
    
    UI --> Backend
    Backend --> Cloud
    
    class UI uiLayer
    class Backend backendLayer
    class Cloud cloudLayer
```

## 2. æ ¸å¿ƒæŠ€æœ¯æ ˆ

| ç±»åˆ«         | æŠ€æœ¯é€‰å‹                                    |
| :----------- | :------------------------------------------ |
| **æ¡†æ¶**     | .NET 9                                      |
| **è¯­è¨€**     | C# 12ï¼ˆæ”¯æŒPrimary Constructorç­‰æ–°ç‰¹æ€§ï¼‰    |
| **åç«¯æ¶æ„** | Clean Architecture + DDD                    |
| **ORM**      | Entity Framework Coreï¼ˆå«è½¯åˆ é™¤ã€å®¡è®¡è¿½è¸ªï¼‰ |
| **å‰ç«¯ç”Ÿæˆ** | AMISï¼ˆåŠ¨æ€è¡¨å•/è¡¨æ ¼ç”Ÿæˆï¼‰                   |
| **å¾®æœåŠ¡**   | .NET Aspireï¼ˆæœåŠ¡å‘ç°ã€å¥åº·æ£€æŸ¥ï¼‰           |
| **å®¹å™¨ç¼–æ’** | Kubernetesï¼ˆæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰                |
| **èº«ä»½è®¤è¯** | JWT + OAuth2.0ï¼ˆRBAC/ABACæ··åˆæ¨¡å‹ï¼‰         |
| **æ•°æ®è®¿é—®** | Repository Pattern + CQRSï¼ˆéƒ¨åˆ†æ¨¡å—ï¼‰       |

## 3. ä¸»è¦æŠ€æœ¯ç»„ä»¶

#### åŠ¨æ€å¯¼èˆªç³»ç»Ÿ

- **æƒé™åŒæ­¥**ï¼šåŸºäºRBACæ¨¡å‹è‡ªåŠ¨ç”Ÿæˆèœå•æ ‘ï¼Œæ”¯æŒ`PageAttribute`æ³¨è§£é…ç½®å¯è§æ€§
- **å¤šçº§å¯¼èˆª**ï¼šæ”¯æŒæ— é™çº§åµŒå¥—èœå•ï¼Œè‡ªåŠ¨å¤„ç†è·¯ç”±æ‡’åŠ è½½

#### CRUDç”Ÿæˆ

- **è‡ªåŠ¨åŒ–è¡¨å•**ï¼šæ ¹æ®`QueryDto`ç”ŸæˆæŸ¥è¯¢æ¡ä»¶ï¼ˆæ”¯æŒ20+å­—æ®µç±»å‹ï¼Œå¦‚æ—¥æœŸèŒƒå›´ã€ä¸‹æ‹‰é€‰æ‹©ï¼‰
- **éªŒè¯é›†æˆ**ï¼šåŸºäºæ•°æ®æ³¨è§£è‡ªåŠ¨ç”Ÿæˆå‰ç«¯æ ¡éªŒè§„åˆ™ï¼ˆå¦‚`[Required]`â†’å¿…å¡«æç¤ºï¼‰
- **æ‰¹é‡å¤„ç†**ï¼šExcelå¯¼å…¥/å¯¼å‡ºæ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆï¼Œæ”¯æŒæ•°æ®æ ¡éªŒä¸å¼‚æ­¥ä»»åŠ¡

#### æƒé™ç³»ç»Ÿï¼ˆRBAC+ABACï¼‰

- **æƒé™æ ‘ç®¡ç†**ï¼šé€šè¿‡`IPermissionService`åŠ¨æ€åŠ è½½æƒé™èŠ‚ç‚¹
- **ç»†ç²’åº¦æ§åˆ¶**ï¼šæ”¯æŒåŸºäºå±æ€§ï¼ˆå¦‚ç”¨æˆ·éƒ¨é—¨ã€æ•°æ®èŒƒå›´ï¼‰çš„åŠ¨æ€æƒé™åˆ¤å®š

#### å®¡è®¡æ—¥å¿—

- **å…¨é“¾è·¯è¿½è¸ª**ï¼šè®°å½•æ“ä½œäººã€æ—¶é—´ã€IPåœ°å€åŠæ•°æ®å˜æ›´è¯¦æƒ…
- **å®ä½“åŸºç±»**ï¼š`AuditableEntityBase<TKey>`è‡ªåŠ¨è®°å½•åˆ›å»º/ä¿®æ”¹ä¿¡æ¯

#### å®ä½“æ¡†æ¶æ‰©å±•

- **å…¨å±€è¿‡æ»¤å™¨**ï¼šè‡ªåŠ¨æ³¨å…¥å¤šç§Ÿæˆ·éš”ç¦»ï¼ˆ`TenantId`ï¼‰å’Œè½¯åˆ é™¤ï¼ˆ`IsDeleted`ï¼‰
- **é›ªèŠ±IDç”Ÿæˆ**ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹å”¯ä¸€ä¸»é”®æ”¯æŒ

#### æœåŠ¡è‡ªåŠ¨æ³¨å†Œ

é€šè¿‡æ ‡è®°æ¥å£å®ç°ä¾èµ–æ³¨å…¥è‡ªåŠ¨åŒ–ï¼š

- `IScopedDependency`ï¼šå¦‚æ•°æ®åº“ä¸Šä¸‹æ–‡ï¼ˆDbContextï¼‰
- `ITransientDependency`ï¼šå¦‚å·¥å…·ç±»æœåŠ¡
- `ISingletonDependency`ï¼šå¦‚é…ç½®ä¸­å¿ƒå®¢æˆ·ç«¯

#### é…ç½®ä¸­å¿ƒ

- **å¤šç¯å¢ƒé…ç½®ç®¡ç†**
- **é…ç½®é¡¹å®ä½“: ConfigItem**

- **åº”ç”¨ç®¡ç†: App**
- **é…ç½®å‘å¸ƒç®¡ç†**

- **ç‰ˆæœ¬æ§åˆ¶ä¸å›æ»š**

#### é€šç”¨CRUDæœåŠ¡

æä¾›æ³›å‹CRUDæœåŠ¡åŸºç±»ï¼Œç®€åŒ–æ•°æ®æ“ä½œ:

```csharp
public abstract class BaseCRUDService<TEntity, TDto, TKey, TCreateDto, TUpdateDto> : 

  IBaseCRUDService<TEntity, TDto, TKey, TCreateDto, TUpdateDto> 

  where TEntity : class

  where TDto : class

  where TKey : IEquatable<TKey>

  where TCreateDto : class

  where TUpdateDto : class

{

  // çœç•¥å®ç°...

}
```

#### èšåˆå™¨

**æä¾›é«˜çº§æ•°æ®èšåˆèƒ½åŠ›:**

**å­—æ®µåŠ¨æ€æ›¿æ¢**

**æ•°æ®æºå…³è”**

**æ¨¡æ¿åŒ–å±•ç¤º**

**è¯­æ³•è§„åˆ™ï¼š**

- **é™æ€æ›¿æ¢**  
  ç›´æ¥ä½¿ç”¨æ¨¡æ¿ä¿®æ”¹å­—æ®µå€¼ï¼Œæ— éœ€è¯·æ±‚å¤–éƒ¨æ•°æ®æºï¼š

  ```plaintext
  createdBy#User-{value}
  ```

  - **æ•ˆæœ**ï¼š`10001` â†’ `User-10001`

- **åŠ¨æ€æ›¿æ¢**  
  é€šè¿‡æ•°æ®æºè·å–å­—æ®µå€¼ï¼Œæ›¿æ¢åŸå€¼ï¼š

  ```plaintext
  updatedBy=/user/{value}.name
  ```

  - è¯·æ±‚ `/user/10002` è·å– `name` å­—æ®µå€¼ï¼Œå¦‚ `User-10002`
  - **æ•ˆæœ**ï¼š`10002` â†’ `User-10002`

- **åŠ¨æ€è¡¥å……**  
  å°†æ•°æ®æºå­—æ®µè¿½åŠ åˆ°åŸå€¼åï¼ˆé»˜è®¤åˆ†éš”ç¬¦ä¸ºç©ºæ ¼ï¼‰ï¼š

  ```plaintext
  items.createdBy=/user/{value}.fullName#{value} ({field})
  ```

  - è‹¥åŸå€¼ä¸º `10003`ï¼Œæ•°æ®æºè¿”å› `fullName: "User-10003"`
  - **æ•ˆæœ**ï¼š`10003` â†’ `10003 (User-10003)`

- **å¼€ç®±æ˜“ç”¨ï¼š**

  ```csharp
  /// <summary>
  /// é…ç½®å‘å¸ƒå†å²DTO
  /// </summary>
  public class ConfigPublishHistoryDto
  {
      /// <summary>
      /// åº”ç”¨ID
      /// </summary>
      [DisplayName("åº”ç”¨ID")]
      public string AppId { get; set; }
  
      ...
      
      /// <summary>
      /// å‘å¸ƒæ—¶é—´
      /// </summary>
      [DisplayName("å‘å¸ƒæ—¶é—´")]
      [DisplayFormat(DataFormatString = "{0:yyyy-MM-dd HH:mm:ss}")]
      public DateTime CreatedAt { get; set; }
  
      /// <summary>
      /// å‘å¸ƒäººï¼ˆé€šè¿‡CreatedByå±æ€§è·å–å‘å¸ƒäººä¿¡æ¯ï¼‰
      /// TODO: åº”æä¾›èšåˆå™¨ç‹¬ç«‹çš„å†…éƒ¨æ¥å£
      /// </summary>
      [DisplayName("å‘å¸ƒäºº")]
      [AggregateField(dataSource: "http://identity/api/identity/users/{value}.data.name", template: "ç”¨æˆ·: {field}")]
      public string CreatedBy { get; set; }
  }
  ```

  

### 4. é¡¹ç›®ç»“æ„

CodeSpiritæ¡†æ¶é‡‡ç”¨ä»¥ä¸‹é¡¹ç›®ç»“æ„ï¼š

```c#
Src/
â”œâ”€â”€ ApiServices/
â”‚   â”œâ”€â”€ CodeSpirit.IdentityApi/           # èº«ä»½è®¤è¯API
â”‚   â”œâ”€â”€ CodeSpirit.OrderApi/              # è®¢å•æœåŠ¡API
â”‚   â””â”€â”€ CodeSpirit.ConfigCenter/          # é…ç½®ä¸­å¿ƒ
â”‚       â””â”€â”€ CodeSpirit.ConfigCenter.Client/ # é…ç½®ä¸­å¿ƒå®¢æˆ·ç«¯
â”œâ”€â”€ Components/
â”‚   â”œâ”€â”€ CodeSpirit.Aggregator/            # èšåˆå™¨ç»„ä»¶
â”‚   â”œâ”€â”€ CodeSpirit.Amis/                  # UIç”Ÿæˆå¼•æ“
â”‚   â”œâ”€â”€ CodeSpirit.Authorization/         # æƒé™ç»„ä»¶
â”‚   â””â”€â”€ CodeSpirit.Navigation/            # å¯¼èˆªç»„ä»¶
â”œâ”€â”€ CodeSpirit.AppHost/                   # Aspireåº”ç”¨å®¿ä¸»
â”œâ”€â”€ CodeSpirit.Core/                      # æ ¸å¿ƒå®šä¹‰
â”œâ”€â”€ CodeSpirit.ServiceDefaults/           # æœåŠ¡é»˜è®¤é…ç½®
â”œâ”€â”€ CodeSpirit.Shared/                    # å…±äº«åº“
â”œâ”€â”€ CodeSpirit.Web/                       # Webç›¸å…³ç»„ä»¶
â””â”€â”€ Tests/
    â”œâ”€â”€ Components/
    â”‚   â”œâ”€â”€ CodeSpirit.Aggregator.Tests/
    â”‚   â”œâ”€â”€ CodeSpirit.Authorization.Tests/
    â”‚   â””â”€â”€ CodeSpirit.Components.TestsBase/
    â”œâ”€â”€ ApiServices/
    â”‚   â””â”€â”€ CodeSpirit.IdentityApi.Tests/
    â””â”€â”€ CodeSpirit.Tests/                 # é€šç”¨æµ‹è¯•
```
