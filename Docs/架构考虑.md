# 总体技术架构设计

# 一、总体架构说明

本架构文档旨在详细描述基于云原生技术体系的整体架构设计，涵盖微服务框架、容器技术、DevOps 实践、配置中心、数据库、持久化存储、日志服务、全文检索与大数据套件、消息队列以及后端框架等多个方面。本架构充分利用当今主流的技术栈，旨在构建一个高性能、高可用、可扩展的分布式系统。

## 1. 微服务框架Dapr

Dapr（Distributed Application Runtime）是一款开源、可移植的微服务运行时，提供了服务调用、状态管理、发布/订阅、绑定、秘密管理等构建模块。通过使用 Dapr，我们可以：

- 简化微服务的开发和运维
- 提高系统的可扩展性和可维护性
- 增强应用程序的可靠性和性能

## 2. 容器技术（Docker+k8s）

容器技术主要为我们解决：

- 提高系统的可移植性、可扩展性和可靠性
- 简化开发和运维流程
- 降低成本（前期降低的是维护和运营成本，中后期可以降低硬件成本）
- 微服务架构最佳搭档

### 2.1 编排及自动化管理

#### 2.1.1 Kubernetes（k8s）

Kubernetes 是目前最主流的容器编排平台，提供了自动部署、扩展和管理容器化应用程序的机制。利用 Kubernetes，我们可以实现应用的自动伸缩、服务发现、负载均衡以及滚动更新和回滚等功能，提高系统的可用性和可靠性。

### 2.2 构建

#### 2.2.1 Docker

Docker 是一种容器化技术，允许开发者将应用程序及其依赖打包到一个可移植的容器中，实现一次构建，随处运行。Docker 容器具有轻量级、启动快和资源隔离等优点。

### 2.3 容器镜像仓库

#### 2.3.1 腾讯云容器镜像仓库

腾讯云容器镜像仓库提供了高可用、高性能的容器镜像存储和分发服务。支持私有和公有镜像的管理，提供安全的访问控制和高速的镜像分发，提升了容器部署和启动的效率。

## 3. DevOps

### 3.1 Azure DevOps

Azure DevOps 提供了一整套开发者服务，包括代码仓库管理、持续集成、持续交付和测试等功能。

#### 3.1.1 代码分支流

采用 GitFlow 或类似的分支策略来管理代码分支，确保团队协作的效率和代码质量。

#### 3.1.2 自动构建自动发布

利用 Azure Pipelines，实现代码的持续集成和持续交付。当代码提交到指定分支时，自动触发构建和部署流程，减少人为干预，提高发布速度和可靠性。

## 4. 配置中心

### 4.1 AgileConfig（轻量配置中心）

AgileConfig 是一款轻量级的分布式配置中心，支持配置的动态更新和推送。通过集中管理应用配置，提高配置的统一性和管理效率，支持多环境、多集群的配置管理。

## 5. 数据库

### 5.1 Redis

Redis 是一款开源的高性能内存数据库，支持多种数据结构，常用于缓存、会话管理和消息队列等场景。

**注意：**框架采用云端Redis集群，以避免业务峰值时因单实例性能达到瓶颈导致的雪崩。

### 5.2 SQL Server（或 MySQL）

SQL Server 和 MySQL 都是关系型数据库管理系统，提供了可靠的数据存储和查询能力。根据业务需求和团队技术栈选择其中一种作为主要的关系型数据库。

### 5.3 Elasticsearch

Elasticsearch 是一个分布式的全文搜索和分析引擎，具有高可用性和可扩展性，常用于日志分析和全文检索等场景。

在本框架中，Elasticsearch 的主要作用如下：

- 业务数据的全文检索和分析
- 统一查询（避免跨库查询）
- 业务数据备份（所有业务数据均会在Elasticsearch 中产生备份）
- 审计日志（避免因日志量过大，传统关系型数据库的插入及全文检索的瓶颈）
- 日志分析及监控
- 性能监控（依托审计日志）

## 6. 持久化存储

### 6.1 腾讯云 COS

腾讯云对象存储服务（COS）提供了高可靠性、高可用性和高扩展性的存储解决方案，适用于存储和管理海量的非结构化数据，如图片、音频、视频和日志文件等。

## 7. 日志服务

### 7.1 Seq

Seq 是一款结构化日志服务器，可以集中收集、存储和查询应用程序的日志数据。支持多种日志格式和查询方式，帮助开发者快速定位和解决问题。

## 8. 全文检索及大数据套件

### 8.1 Elasticsearch

用于存储和检索日志、业务数据，支持全文搜索和复杂的分析功能。

### 8.2 Kibana

Kibana 是 Elasticsearch 的可视化分析平台，提供丰富的图表和仪表盘，用于展示 Elasticsearch 中的数据。

### 8.3 Logstash

Logstash 是一个数据收集引擎，支持实时管道传输，可以从多种来源收集数据，进行过滤和转换后输出到指定的存储目标，如 Elasticsearch。

## 9. 消息队列

### 9.1 RabbitMQ

RabbitMQ 是一款开源的消息代理软件，实现了高级消息队列协议（AMQP）。用于在分布式系统中实现异步通信、解耦和削峰填谷等功能。

## 10. 后端框架

### 10.1 .NET 8

在本架构中，采用 .NET 8 作为主要的后端开发框架，具有以下优势：

1. **性能提升**

- **高效运行时**：.NET 8 对运行时进行了优化，提高了应用程序的执行效率，减少了内存占用和启动时间。
- **改进的 JIT 编译器**：通过增强的即时编译（JIT）技术，提升了代码的执行速度。

2. **跨平台支持及容器化友好**

- **多平台兼容性**：支持 Windows、Linux、macOS 等多种操作系统，方便在不同环境下部署和运行。
- **容器化友好**：与 Docker、Kubernetes 等容器技术深度集成，支持云原生应用的开发和部署。

3. **丰富的生态系统**

- **完善的类库和框架**：内置大量的标准库和第三方库，满足各种业务需求。
- **活跃的社区支持**：拥有庞大的开发者社区，提供丰富的资源和技术支持。

4. **新特性与改进**

- **C# 11 支持**：引入了最新的 C# 语言特性，提高了代码的可读性和开发效率。
- **改进的异步编程模型**：进一步优化了 async/await 机制，提升了并发处理能力。

5. **安全性增强**

- **内置安全功能**：提供了先进的加密算法和安全协议支持，增强了应用的安全性。
- **持续更新**：微软提供长期支持（LTS），确保安全漏洞能及时得到修复。

6. **与云服务的深度集成**

- **Azure 支持**：与 Azure 云服务无缝集成，方便使用云上的各种服务，如存储、数据库、消息队列等。
- **Dapr 集成**：对 Dapr 提供了良好的支持，简化了微服务的开发和部署。

7. **开发效率提升**

- **改进的开发工具**：Visual Studio 2022 和 Visual Studio Code 提供了更强大的调试、测试和重构功能。
- **热重载（Hot Reload）**：支持代码的热重载，开发者可以在不重启应用的情况下看到代码修改的效果。

8. **微服务和现代架构友好**

- **模块化设计**：支持模块化和可插拔的架构，适合构建微服务和分布式系统。
- **gRPC 支持**：增强了对 gRPC 的支持，适用于高性能的服务间通信。

9. **可观测性**

- **内置诊断工具**：提供了丰富的日志、跟踪和性能指标收集工具，方便监控和调试应用。
- **OpenTelemetry 支持**：兼容 OpenTelemetry 标准，便于与第三方监控系统集成。

#### 10.1.1 .NET Aspire

.NET Aspire 是一套基于 .NET 的快速开发框架，提供模块化、可扩展的基础设施，简化应用程序的开发。

#### 10.1.2 存储

##### 10.1.2.1 依托云存储

利用云存储服务（如腾讯云 COS），存储大型文件和非结构化数据，提高数据的可靠性和可扩展性。

#### 10.1.3 ORM

##### 10.1.3.1 EntityFramework Core 8.0

EntityFramework Core 8.0 是微软提供的开源 ORM 框架，支持 LINQ 查询、多数据库供应商和代码优先等特性。

###### 10.1.3.1.1 数据筛选器

- `ITenant`：用于多租户数据隔离。
- `IDeletionAuditedObject`：用于软删除数据的过滤。
- `IIsActive`：用于筛选激活状态的数据。

###### 10.1.3.1.2 实体变更事件推送

在实体发生变化时，自动推送事件，便于其他服务订阅和处理。

###### 10.1.3.1.3 审计字段自动赋值

自动为实体的审计字段（如创建时间、修改时间、创建者等）赋值，简化开发。

###### 10.1.3.1.4 分库分表

支持根据业务需求进行数据库的水平和垂直拆分，提高系统的性能和可扩展性。

#### 10.1.4 事件总线

- `DaprEventBus`：基于 Dapr 的事件总线，实现服务之间的消息传递。
- `LoggerEventBus`：用于日志事件的传递和处理。

#### 10.1.5 审计服务

- 基于 `AuditMiddleware`：通过中间件拦截请求，实现审计日志的收集。
- 基于 MQ、Logstash 处理存储到 Elasticsearch：将审计日志通过消息队列和 Logstash 处理后，存储到 Elasticsearch 中。
- 依托 Elasticsearch 创建索引别名：利用索引别名实现日志数据的管理和查询优化。

#### 10.1.6 全局异常处理

- `HttpResponseExceptionFilter`：全局异常过滤器，统一处理异常并返回标准的 HTTP 响应。

#### 10.1.7 雪花 ID

使用分布式 ID 生成算法（如雪花算法）生成全局唯一 ID，确保分布式系统中 ID 的唯一性。

#### 10.1.8 服务自动注册

- `IScopedDependency`：作用域依赖注入。
- `ITransientDependency`：瞬态依赖注入。
- `ISingletonDependency`：单例依赖注入。

通过这些接口，实现服务的自动注册，简化依赖注入的配置。

#### 10.1.9 用户标识获取

- `IIdentityAccessor`：用于获取当前用户的身份信息。

##### 10.1.9.1 内部服务支持从 Header 获取租户 ID

内部服务通过读取 HTTP 请求头中的租户 ID，实现多租户的支持和数据隔离。

#### 10.1.10 身份认证与授权

- **OAuth 2.0 / JWT**：采用行业标准的身份认证协议，确保 API 安全。
- **角色权限控制（RBAC）**：实现基于角色的权限管理，细化用户操作权限。

#### 10.1.11 统一错误码

统一错误码，便于排查问题。

### 10.2 支持 Java、Go 以及其他主流编程语言

为了满足不同团队和业务的需求，系统架构支持 Java、Go 等其他主流编程语言的接入，确保系统的开放性和可扩展性。

# 二、架构优势

本架构设计基于云原生技术体系，具有以下优势：

### 1. 高可用性和可扩展性

- **微服务架构**：通过 Dapr 实现服务的解耦和独立部署，增强系统的容错能力和灵活性。
- **容器化部署**：利用 Docker 和 Kubernetes，实现应用的自动化部署、扩展和管理，支持弹性伸缩，满足高并发和大流量的需求。

### 2. 高开发效率

- **统一的后端框架**：采用 .NET 8 和 .NET Aspire，加速应用开发，提供丰富的基础设施和工具支持。
- **高可读性的代码：**依托云原生架构及微服务设计，大大简化了后端代码的复杂度，是服务架构变得简单干净可控。
- **自动化构建和发布**：利用 Azure DevOps，实现持续集成和持续交付，缩短开发周期，减少人为错误。
- **服务自动注册和依赖注入**：通过接口约定（如 `IScopedDependency` 等），简化依赖注入的配置，提高代码的可维护性。

### 3. 强大的数据处理能力

- **多样化的数据库支持**：同时支持关系型数据库（SQL Server 或 MySQL）、NoSQL 数据库（Redis）和全文检索引擎（Elasticsearch），满足不同类型的数据存储需求。
- **分库分表**：支持数据库的水平和垂直拆分，提升数据访问性能，适应数据量增长。
- **实体变更事件推送**：及时响应数据变化，支持事件驱动的架构模式。

### 4. 完善的日志和监控体系

- **日志服务（Seq）**：集中管理和查询日志，快速定位问题。
- **全文检索和大数据分析**：利用 Elasticsearch、Kibana 和 Logstash，实现日志和数据的收集、存储、分析和可视化，提升系统的可观测性。
- **审计服务**：通过审计中间件和 Elasticsearch，记录和分析用户操作，提高系统的安全性和合规性。

### 5. 高安全性和可靠性

- **配置中心（AgileConfig）**：集中管理配置，支持动态更新，降低配置错误的风险。
- **消息队列（RabbitMQ）**：实现异步通信和系统解耦，提高系统的稳定性和响应速度。
- **全局异常处理**：统一处理异常，提高系统的健壮性。

### 6. 灵活的技术栈支持

- **多语言支持**：除了 .NET 8，还支持 Java、Go 等主流编程语言，满足不同团队的技术偏好和业务需求。
- **云存储和 OSS**：利用云服务提供商的存储能力，提高数据的可靠性和可扩展性。

### 7. 规范的开发和运维流程

- **代码分支流**：采用合理的分支策略，保障代码质量和团队协作效率。
- **自动构建和发布**：通过持续集成和持续交付，减少人工干预，提高发布的可靠性。

### 8. 易于扩展和维护

- **模块化设计**：各组件之间松耦合，便于独立开发和维护。
- **依赖注入和接口设计**：提高代码的可测试性和可维护性。

### 9. 高性能

- **缓存（Redis）**：提高数据访问速度，减轻数据库压力。
- **雪花 ID**：高效生成全局唯一 ID，性能优异。

### 10. 多租户支持

- **数据筛选器（`ITenant`）**：实现多租户数据隔离，支持 SaaS 模式的业务场景。
- **用户标识获取（`IIdentityAccessor`）**：准确获取用户和租户信息，提高业务逻辑的准确性。

# 三、服务设计

## 1. 标识服务（Identity Service）

### 1.1 功能概述

标识服务（Identity Service）负责用户身份验证、授权和用户信息管理，主要功能包括：

- 用户注册与登录：提供安全的用户注册和认证机制。
- 令牌管理：生成和验证访问令牌（如 JWT），管理令牌的生命周期。
- 角色与权限控制：管理用户角色，分配权限，支持细粒度的访问控制。
- 多租户支持：实现多租户数据隔离，支持 SaaS 模式的业务场景。

### 1.2 关键技术实现

- **OAuth 2.0 与 JWT**：采用行业标准的认证协议，确保系统安全。
- **IIdentityAccessor**：利用该接口获取当前用户信息，支持从请求头获取租户 ID。

- **数据筛选器**：使用 `ITenant` 实现多租户数据隔离，`IDeletionAuditedObject` 处理软删除。

- **Redis**：缓存用户会话和权限信息，提高响应速度，减轻数据库压力。

- **DaprEventBus**：通过事件总线发布和订阅身份相关事件，如用户注册、密码重置等。

## 2. 订单服务（Order Service）

### 2.1 功能概述

订单服务负责订单生命周期的管理和支付处理，主要功能包括：

- **订单管理**：创建、更新、查询和取消订单。
- **支付处理**：集成第三方支付网关，处理支付事务。
- **订单状态跟踪**：实时更新和查询订单状态。
- **与其他服务的协同**：与库存、用户、物流等服务交互，完成完整的业务流程。

### 2.2 关键技术实现

- **分布式事务管理**：依托Dapr实现分布式事务管理，确保支付过程的原子性和一致性，处理支付结果的回调和确认。
- **参数配置**：基于AgileConfig动态管理支付参数、订单策略等配置，支持热更新。
- **使用 Elasticsearch 替代数据库实现客户端订单数据高频查询：**
  - ES支持高效的全文检索和复杂查询
  - ES具备高并发性能
  - ES具备实时数据处理能力
  - 分布式架构，易于扩展
- **发布/订阅模式：**
  - **事件驱动**：使用 Dapr 的 Pub/Sub 构建模块，将订单的创建、支付、状态变更等操作以事件的形式发布，其他服务（如库存、通知）订阅这些事件，实现松耦合。
  - **消息中间件**：通过选择高性能的消息队列，提升消息传递的效率和可靠性。
  - **削峰填谷**：利用消息队列的缓冲能力，平滑高峰期的请求压力，防止系统过载。
- **服务调用优化：**
  - **异步通信**：利用 Dapr 的服务调用 API，可以支持异步调用，减少同步阻塞，提高吞吐量。
  - **负载均衡**：Dapr 内置服务发现和负载均衡机制，自动将请求分发到多个服务实例，避免单点瓶颈。
  - **重试策略**：配置 Dapr 的重试和超时策略，在服务调用失败时自动重试，增强服务的稳定性。
- **其他服务集成：**
  - **库存服务**：下单时检查和锁定库存，支付成功后扣减库存。
  - **用户服务**：获取用户信息和优惠政策，更新用户订单历史。
  - **物流服务**：订单支付完成后，通知物流服务安排发货。
  - **通知服务**：通过消息队列或 Dapr Pub/Sub，发送短信、邮件等通知。
- **性能优化：**
  - **雪花 ID 生成器**：使用分布式 ID 算法，确保订单号的唯一性和有序性。
  - **数据库索引**：优化数据库索引设计，提高查询效率。
  - **分布式缓存**：使用 Dapr 的状态管理组件，将订单的临时状态存储在高速缓存中，减少数据库访问，提高响应速度。
  - **缓存策略**：合理设置缓存过期时间，平衡数据一致性和性能。
  - **分库分表**：根据业务需求对订单数据进行水平拆分，提高数据库性能。
  - **并发控制**：基于Actor模型实现并发控制。Actor 模型天然支持并发控制，避免了多线程竞争，提高了系统的稳定性。